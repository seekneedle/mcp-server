<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>城市间路线图</title>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=46015e8383014a3fd7df676b73e45ae2"></script>
    <style type="text/css">
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script type="text/javascript">
    // 城市坐标点
    var points = ${points_json};
    // 线路数据
    var lines = ${lines_json};

    // 初始化地图
    function initMap() {
        var map = new T.Map('map');

        // 设置初始视图（后面会调整）
        map.centerAndZoom(new T.LngLat(116.407, 39.904), 5);

        // 添加标记点
        addMarkers(map);

        // 绘制路线
        drawRoute(map);

        // 添加覆盖物后重新计算视图
        adjustView(map);
    }

    // 添加标注点并显示名称
    function addMarkers(map) {
        for (var i = 0; i < points.length; i++) {
            var marker = new T.Marker(new T.LngLat(points[i].lng, points[i].lat));
            map.addOverLay(marker);

            var label = new T.Label({
                text: points[i].index,
                position: new T.LngLat(points[i].lng, points[i].lat),
                offset: new T.Point(-10, -20),
                style: {
                    color: 'white',
                    backgroundColor: 'blue',
                    border: '1px solid white',
                    padding: '2px',
                    borderRadius: '50%'
                }
            });
            map.addOverLay(label);
        }
    }

    // 绘制连接线
    function drawRoute(map) {
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            var polyline = new T.Polyline(
                [
                    new T.LngLat(line.start_lng, line.start_lat),
                    new T.LngLat(line.end_lng, line.end_lat)
                ],
                {
                    strokeColor: "#0066FF",
                    strokeWeight: 5,
                    strokeOpacity: 0.8
                }
            );
            map.addOverLay(polyline);
        }
    }

    // 调整视图以显示所有点
    function adjustView(map) {
        // 收集所有坐标点（标记点和线路端点）
        var allPoints = points.map(p => new T.LngLat(p.lng, p.lat));
        for (var i = 0; i < lines.length; i++) {
            allPoints.push(new T.LngLat(lines[i].start_lng, lines[i].start_lat));
            allPoints.push(new T.LngLat(lines[i].end_lng, lines[i].end_lat));
        }

        // 计算边界
        var bounds = new T.LngLatBounds();
        for (var i = 0; i < allPoints.length; i++) {
            bounds.extend(allPoints[i]);
        }

        // 调整视图
        map.fitBounds(bounds.pad(0.2));  // 添加20%的padding
    }

    // 页面加载完成后初始化地图
    window.onload = initMap;
</script>
</body>
</html>