<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>城市间路线图</title>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=46015e8383014a3fd7df676b73e45ae2"></script>
    <style type="text/css">
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script type="text/javascript">
    // 城市坐标点（按顺序排列）
    var points = ${points_json};

    // 初始化地图
    function initMap() {
        var map = new T.Map('map');

        // 计算中心点
        var centerLng = (points[0].lng + points[points.length-1].lng) / 2;
        var centerLat = (points[0].lat + points[points.length-1].lat) / 2;
        var center = new T.LngLat(centerLng, centerLat);

        // 设置初始缩放级别（中等缩放）
        map.centerAndZoom(center, 7);

        // 添加标记点
        addMarkers(map);

        // 绘制路线
        drawRoute(map);

        // 添加覆盖物后重新计算视图
        adjustView(map);
    }

    // 添加标注点并显示数字
    function addMarkers(map) {
        for (var i = 0; i < points.length; i++) {
            var marker = new T.Marker(new T.LngLat(points[i].lng, points[i].lat));
            map.addOverLay(marker);

            var label = new T.Label({
                text: points[i].index,
                position: new T.LngLat(points[i].lng, points[i].lat),
                offset: new T.Point(-10, -20),
                style: {
                    color: 'white',
                    backgroundColor: 'blue',
                    border: '1px solid white',
                    padding: '2px',
                    borderRadius: '50%'
                }
            });
            map.addOverLay(label);
        }
    }

    // 绘制连接线（按顺序连接）
    function drawRoute(map) {
        // 创建折线对象
        var polyline = new T.Polyline(
            points.map(point => new T.LngLat(point.lng, point.lat)),
            {
                strokeColor: "#0066FF",
                strokeWeight: 5,
                strokeOpacity: 0.8
            }
        );
        map.addOverLay(polyline);
    }

    // 调整视图以显示所有点
    function adjustView(map) {
        // 计算最小和最大经纬度
        var minLng = Math.min(...points.map(p => p.lng));
        var maxLng = Math.max(...points.map(p => p.lng));
        var minLat = Math.min(...points.map(p => p.lat));
        var maxLat = Math.max(...points.map(p => p.lat));

        // 计算中心点
        var centerLng = (minLng + maxLng) / 2;
        var centerLat = (minLat + maxLat) / 2;
        var center = new T.LngLat(centerLng, centerLat);

        // 计算经纬度跨度
        var lngSpan = maxLng - minLng;
        var latSpan = maxLat - minLat;

        // 根据跨度估算合适的缩放级别
        var zoom;
        var span = Math.max(lngSpan, latSpan);

        if (span < 0.1) zoom = 11;
        else if (span < 0.2) zoom = 10;
        else if (span < 0.5) zoom = 9;
        else if (span < 1) zoom = 8;
        else if (span < 2) zoom = 7;
        else if (span < 4) zoom = 6;
        else if (span < 8) zoom = 5;
        else if (span < 16) zoom = 4;
        else zoom = 3;

        // 设置地图视图
        map.centerAndZoom(center, zoom+1);
    }

    // 页面加载完成后初始化地图
    window.onload = initMap;
</script>
</body>
</html>